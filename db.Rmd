---
title: "Database"
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F)
```


```{r, include=F}
## Load packages
library(DBI)
library(RPostgres)
library(here)
library(glue)
library(leaflet)
library(lwgeom)
library(dplyr)
library(ggplot2)
library(rmarkdown)
library(DT)
```

# Resources
* [DT::datatables - options](https://datatables.net/reference/option/)

# Database connection
```{r dbconn, class.source='fold-show'}
pass <- readLines("../../pwd.txt")

conn <- DBI::dbConnect(
  RPostgres::Postgres(),
  dbname   = "personal",
  host     = "localhost",
  port     = 5432,
  user     = "cgrant",
  password = pass
)
```


# DB query
```{r dbquery, class.source='fold-show'}
# tbls <- dbListTables(conn)
sql <- glue("SELECT * FROM sleepdata")
res <- dbGetQuery(conn, sql)
# cols <- names(res)

datatable(res, options=list(scrollX=T))
```

# Plots

## Sleep quality
```{r sleepquality}
plt1 <- ggplot(res, aes(x=start_time, y=sleep_quality)) +
  geom_line(color="blue", size=1) +
  ylab("Sleep Quality") +
  xlab("Start Date")
plt1
```

## Steps
```{r steps}
plt2 <- ggplot(res, aes(x=start_time, y=steps)) +
  geom_line(color="red", size=1) +
  ylab("Steps") +
  xlab("Start Date")
plt2
```

## Sleep time
```{r sleeptime}
plt3 <- ggplot(res, aes(x=start_time, y=(seconds_asleep / 60) / 60)) +
  geom_line(color="purple", size=1) +
  ylab("Hours Asleep") +
  xlab("Start Date")
plt3
```

## Movement
```{r movement}
plt4 <- ggplot(res, aes(x=start_time, y=movements_per_hour)) +
  geom_line(color="red", size=1) +
  ylab("Movements per hour") +
  xlab("Start Date")
plt4
```

## Time until sleep
```{r tts}
plt5 <- ggplot(res, aes(x=start_time, y=seconds_until_sleep / 60)) +
  geom_line(color="red", size=1) +
  ylab("Minutes until sleep") +
  xlab("Start Date")
plt5
```